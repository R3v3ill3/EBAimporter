{% extends "base.html" %}

{% block title %}Clustering Result: {{ run_id }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/clustering">Clustering</a></li>
            <li class="breadcrumb-item active">{{ run_id[:8] }}...</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-8">
            <!-- Clustering Overview -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Clustering Result</h4>
                    <span class="badge bg-secondary">{{ report_data.algorithm }}</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Run ID:</strong> <code>{{ report_data.run_id }}</code><br>
                            <strong>Algorithm:</strong> {{ report_data.algorithm }}<br>
                            <strong>Documents:</strong> {{ report_data.num_documents }}<br>
                            <strong>Clusters:</strong> {{ report_data.num_clusters }}
                        </div>
                        <div class="col-md-6">
                            <strong>Outliers:</strong> {{ report_data.outliers|length if report_data.outliers else 0 }}<br>
                            <strong>Timestamp:</strong> {{ report_data.timestamp[:19] if report_data.timestamp else 'Unknown' }}<br>
                            <strong>Execution Time:</strong> {{ "%.2f"|format(report_data.execution_time_seconds) }}s<br>
                            {% if report_data.silhouette_score %}
                            <strong>Silhouette Score:</strong> {{ "%.3f"|format(report_data.silhouette_score) }}
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if report_data.parameters %}
                    <hr>
                    <h6>Parameters:</h6>
                    <div class="bg-light p-2 rounded">
                        {% for key, value in report_data.parameters.items() %}
                        <small><strong>{{ key }}:</strong> {{ value }}</small><br>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Cluster Candidates -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-users"></i> Family Candidates ({{ candidates|length }})
                    </h5>
                    {% if candidates %}
                    <button class="btn btn-success btn-sm" onclick="approveAllClusters()">
                        <i class="fas fa-check"></i> Approve All
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if candidates %}
                    <form method="post" action="/clustering/{{ run_id }}/approve" id="approvalForm">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAll" onchange="toggleAll()">
                                        </th>
                                        <th>Cluster ID</th>
                                        <th>Size</th>
                                        <th>Confidence</th>
                                        <th>Centroid EA</th>
                                        <th>Documents</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for candidate in candidates %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="cluster_checkbox" 
                                                   value="{{ candidate.cluster_id }}" class="cluster-checkbox">
                                        </td>
                                        <td>
                                            <code>{{ candidate.cluster_id[:8] }}...</code>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">{{ candidate.size }}</span>
                                        </td>
                                        <td>
                                            <div class="progress" style="width: 100px;">
                                                {% set confidence_pct = (candidate.confidence_score * 100)|round %}
                                                <div class="progress-bar 
                                                    {% if confidence_pct >= 80 %}bg-success
                                                    {% elif confidence_pct >= 60 %}bg-warning
                                                    {% else %}bg-danger{% endif %}"
                                                    style="width: {{ confidence_pct }}%">
                                                    {{ confidence_pct }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ candidate.centroid_ea_id[:16] }}...</small>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-info" 
                                                    onclick="toggleDocuments('{{ candidate.cluster_id }}')">
                                                <i class="fas fa-eye"></i> View
                                            </button>
                                        </td>
                                    </tr>
                                    <tr id="docs-{{ candidate.cluster_id }}" style="display: none;">
                                        <td colspan="6">
                                            <div class="bg-light p-3 rounded">
                                                <h6>Documents in this cluster:</h6>
                                                {% set ea_ids = candidate.ea_ids.split(',') if candidate.ea_ids else [] %}
                                                <div class="row">
                                                    {% for ea_id in ea_ids %}
                                                    <div class="col-md-6">
                                                        <small class="text-muted">
                                                            <i class="fas fa-file-pdf"></i> {{ ea_id.strip() }}
                                                        </small>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3">
                            <input type="hidden" name="approved_clusters" id="approvedClusters">
                            <button type="submit" class="btn btn-success" onclick="submitApproval()">
                                <i class="fas fa-check"></i> Approve Selected Clusters
                            </button>
                            <a href="/clustering" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Clustering
                            </a>
                        </div>
                    </form>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No cluster candidates found in this result.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Statistics -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Statistics</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h4 class="text-primary">{{ report_data.num_clusters }}</h4>
                                <small class="text-muted">Clusters</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h4 class="text-info">{{ report_data.num_documents }}</h4>
                            <small class="text-muted">Documents</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h4 class="text-warning">{{ report_data.outliers|length if report_data.outliers else 0 }}</h4>
                                <small class="text-muted">Outliers</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success">
                                {% if candidates %}
                                    {{ "%.1f"|format((candidates|map(attribute='size')|sum / candidates|length)) }}
                                {% else %}
                                    0
                                {% endif %}
                            </h4>
                            <small class="text-muted">Avg Size</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quality Metrics -->
            {% if candidates %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Quality Assessment</h6>
                </div>
                <div class="card-body">
                    {% set high_quality = candidates|selectattr('confidence_score', '>=', 0.8)|list|length %}
                    {% set medium_quality = candidates|selectattr('confidence_score', '>=', 0.6)|selectattr('confidence_score', '<', 0.8)|list|length %}
                    {% set low_quality = candidates|selectattr('confidence_score', '<', 0.6)|list|length %}
                    
                    <div class="mb-3">
                        <small class="text-muted">High Quality (≥80%)</small>
                        <div class="progress mb-1" style="height: 20px;">
                            <div class="progress-bar bg-success" style="width: {{ (high_quality / candidates|length * 100)|round }}%">
                                {{ high_quality }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">Medium Quality (60-79%)</small>
                        <div class="progress mb-1" style="height: 20px;">
                            <div class="progress-bar bg-warning" style="width: {{ (medium_quality / candidates|length * 100)|round }}%">
                                {{ medium_quality }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">Low Quality (<60%)</small>
                        <div class="progress mb-1" style="height: 20px;">
                            <div class="progress-bar bg-danger" style="width: {{ (low_quality / candidates|length * 100)|round }}%">
                                {{ low_quality }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Outliers -->
            {% if report_data.outliers %}
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Outliers ({{ report_data.outliers|length }})
                    </h6>
                </div>
                <div class="card-body">
                    <small class="text-muted">Documents that couldn't be clustered:</small>
                    <div class="mt-2" style="max-height: 200px; overflow-y: auto;">
                        {% for outlier in report_data.outliers %}
                        <div class="mb-1">
                            <small class="text-muted">
                                <i class="fas fa-file"></i> {{ outlier }}
                            </small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function toggleAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.cluster-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
}

function approveAllClusters() {
    const checkboxes = document.querySelectorAll('.cluster-checkbox');
    checkboxes.forEach(cb => cb.checked = true);
    document.getElementById('selectAll').checked = true;
}

function toggleDocuments(clusterId) {
    const row = document.getElementById('docs-' + clusterId);
    row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
}

function submitApproval() {
    const checkboxes = document.querySelectorAll('.cluster-checkbox:checked');
    const clusterIds = Array.from(checkboxes).map(cb => cb.value);
    document.getElementById('approvedClusters').value = clusterIds.join(',');
}
</script>
{% endblock %}